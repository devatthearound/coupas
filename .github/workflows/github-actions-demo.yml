name: Build Electron App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 15  # 전체 작업 타임아웃 설정
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        timeout-minutes: 2  # 체크아웃 단계 타임아웃
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        timeout-minutes: 2  # Node.js 설정 단계 타임아웃
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        timeout-minutes: 5  # 의존성 설치 타임아웃
        run: npm ci
        
      - name: Build application
        timeout-minutes: 10  # 빌드 단계 타임아웃
        env:
          SKIP_NOTARIZATION: true
          NODE_OPTIONS: --max-old-space-size=8192
        run: |
          npm run next:build
          npm run electron:build
          npx electron-builder build --mac --x64 --arm64 --publish never
          
      # 아티팩트 업로드 단계를 분리하여 최적화
      - name: Upload x64 artifact
        timeout-minutes: 3  # 업로드 타임아웃
        uses: actions/upload-artifact@v4
        with:
          name: mac-x64
          path: releases/coupas-0.0.1-mac-x64.dmg
          if-no-files-found: warn
          compression-level: 0  # DMG는 이미 압축되어 있음
          
      - name: Upload arm64 artifact
        timeout-minutes: 3  # 업로드 타임아웃
        uses: actions/upload-artifact@v4
        with:
          name: mac-arm64
          path: releases/coupas-0.0.1-mac-arm64.dmg
          if-no-files-found: warn
          compression-level: 0